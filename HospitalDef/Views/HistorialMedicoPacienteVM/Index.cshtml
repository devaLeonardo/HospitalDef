@model IEnumerable<HospitalDef.Models.ViewModels.HistorialMedicoPacienteVM>
<link rel="stylesheet"href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">


<div class="container mt-4">

    <!-- ===== Título ===== -->
    <div class="d-flex align-items-center mb-4">
        <i class="bi bi-clipboard2-pulse fs-2 me-2 text-primary"></i>
        <h2 class="mb-0">Historial Médico por Paciente</h2>
    </div>

    <!-- ===== Buscador ===== -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <label class="form-label fw-semibold">
                Buscar paciente
            </label>
            <input type="text"
                   id="busquedaPaciente"
                   class="form-control"
                   placeholder="Escribe el nombre del paciente..." />
        </div>
    </div>

    <!-- ===== Lista de pacientes ===== -->
    <div class="card shadow-sm mb-4" id="listaPacientesCard" style="display:none;">
        <div class="card-header bg-light fw-semibold">
            Pacientes encontrados
        </div>
        <ul class="list-group list-group-flush" id="listaPacientes"></ul>
    </div>

    <!-- ===== Historial ===== -->
    <div class="card shadow-sm" id="historialCard" style="display:none;">
        <div class="card-header bg-primary text-white d-flex justify-content-between">
            <span id="tituloPaciente"></span>
            <button class="btn btn-sm btn-light" onclick="volverABuscar()">
                Cambiar paciente
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover mb-0" id="tablaHistorial">
                <thead class="table-light">
                    <tr>
                        <th>Fecha</th>
                        <th>Médico</th>
                        <th>Especialidad</th>
                        <th>Diagnóstico</th>
                        <th>Tratamiento</th>
                        <th>Consultorio</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr data-paciente="@item.NombrePaciente">
                            <td>@item.FechaMovimiento.ToShortDateString()</td>
                            <td>@item.NombreDoctor</td>
                            <td>@item.Especialidad</td>
                            <td>@item.Diagnostico</td>
                            <td>@item.Tratamientos</td>
                            <td>@item.Consultorio</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

    </div>
    <a asp-controller="Doctors" asp-action="Index" class="btn btn-outline-secondary px-4 rounded-pill">
        <i class="fas fa-arrow-left me-2"></i>Volver al Modulo
    </a>
</div>

<script>
    const inputBusqueda = document.getElementById("busquedaPaciente");
    const listaPacientes = document.getElementById("listaPacientes");
    const listaCard = document.getElementById("listaPacientesCard");
    const historialCard = document.getElementById("historialCard");
    const tituloPaciente = document.getElementById("tituloPaciente");
    const filasHistorial = document.querySelectorAll("#tablaHistorial tbody tr");

    // Obtener pacientes únicos desde la tabla
    const pacientesUnicos = [...new Set(
        Array.from(filasHistorial).map(f => f.dataset.paciente)
    )];

    inputBusqueda.addEventListener("keyup", () => {
        const texto = inputBusqueda.value.toLowerCase();
        listaPacientes.innerHTML = "";

        if (texto.length < 2) {
            listaCard.style.display = "none";
            return;
        }

        const filtrados = pacientesUnicos.filter(p =>
            p.toLowerCase().includes(texto)
        );

        if (filtrados.length === 0) {
            listaCard.style.display = "none";
            return;
        }

        filtrados.forEach(nombre => {
            const li = document.createElement("li");
            li.className = "list-group-item list-group-item-action";
            li.textContent = nombre;
            li.onclick = () => mostrarHistorial(nombre);
            listaPacientes.appendChild(li);
        });

        listaCard.style.display = "block";
    });

    function mostrarHistorial(nombrePaciente) {
        tituloPaciente.textContent = "Historial de " + nombrePaciente;

        filasHistorial.forEach(fila => {
            fila.style.display =
                fila.dataset.paciente === nombrePaciente ? "" : "none";
        });

        listaCard.style.display = "none";
        historialCard.style.display = "block";
    }

    function volverABuscar() {
        historialCard.style.display = "none";
        inputBusqueda.value = "";
        inputBusqueda.focus();
    }
</script>
