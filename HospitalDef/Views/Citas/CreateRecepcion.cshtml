@model HospitalDef.Models.Cita

@{
    ViewData["Title"] = "Agendar cita - Recepción";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Agendar cita para paciente</h4>
                </div>

                <div class="card-body">
                    <form asp-action="CreateRecepcion" method="post">
                        @Html.AntiForgeryToken()

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- PACIENTE -->
                        <div class="mb-3">
                            <label asp-for="idPaciente" class="form-label fw-bold">Paciente</label>
                            <select asp-for="idPaciente"
                                    asp-items="ViewBag.Pacientes"
                                    class="form-select">
                                <option value="">Seleccione un paciente</option>
                            </select>
                            <span asp-validation-for="idPaciente" class="text-danger"></span>
                        </div>

                        <hr />

                        <!-- ESPECIALIDAD -->
                        <div class="mb-3">
                            <label asp-for="EspecialidadIdFiltro" class="form-label fw-bold">Especialidad</label>
                            <select asp-for="EspecialidadIdFiltro"
                                    class="form-select"
                                    id="EspecialidadSelect"
                                    asp-items="ViewBag.Especialidades">
                                <option value="">Seleccione especialidad</option>
                            </select>
                            <span asp-validation-for="EspecialidadIdFiltro" class="text-danger"></span>
                        </div>

                        <!-- DOCTOR -->
                        <div class="mb-3">
                            <label asp-for="idDoctor" class="form-label fw-bold">Doctor</label>
                            <select asp-for="idDoctor"
                                    class="form-select"
                                    id="DoctorSelect">
                                <option value="">Seleccione doctor</option>
                            </select>
                            <span asp-validation-for="idDoctor" class="text-danger"></span>
                        </div>
                        <div id="infoDoctor" class="mt-3"></div>
                        <!-- FECHA -->
                        <div class="mb-3">
                            <label asp-for="fechaCita" class="form-label fw-bold">Fecha y hora</label>
                            <input asp-for="fechaCita"
                                   type="datetime-local"
                                   class="form-control" />
                            <span asp-validation-for="fechaCita" class="text-danger"></span>
                        </div>

                        <div class="d-flex justify-content-between mt-4">

                            <a asp-action="Index" class="btn btn-outline-secondary px-4">
                                Volver a mi modulo
                            </a>

                            <button type="submit" class="btn btn-outline-primary btn-sm">
                                Agendar
                            </button>


                        </div>

                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const especialidadSelect = document.getElementById("EspecialidadSelect");
            const doctorSelect = document.getElementById("DoctorSelect");
            const infoDoctor = document.getElementById("infoDoctor");

            // 1️⃣ CUANDO CAMBIA ESPECIALIDAD → CARGAR DOCTORES
            especialidadSelect.addEventListener("change", function () {

                const especialidadId = this.value;

                doctorSelect.innerHTML = '<option value="">Seleccione doctor</option>';
                infoDoctor.innerHTML = "";

                if (!especialidadId) return;

                fetch(`/Citas/GetDoctoresPorEspecialidad?IdEspecialidad=${especialidadId}`)
                    .then(r => r.json())
                    .then(data => {

                        console.log("Doctores:", data);

                        data.forEach(d => {
                            const opt = document.createElement("option");
                            opt.value = d.id;
                            opt.textContent = d.nombre;
                            doctorSelect.appendChild(opt);
                        });
                    })
                    .catch(err => console.error(err));
            });

            // 2️⃣ CUANDO CAMBIA DOCTOR → MOSTRAR HORARIO + CONSULTORIO
            doctorSelect.addEventListener("change", function () {

                const doctorId = this.value;
                infoDoctor.innerHTML = "";

                if (!doctorId) return;

                fetch(`/Citas/GetHorarioDoctor?idDoctor=${doctorId}`)
                    .then(r => r.json())
                    .then(data => {

                        if (data.length === 0) {
                            infoDoctor.innerHTML =
                                "<p class='text-danger'>No hay horario registrado.</p>";
                            return;
                        }

                        let html = `
                            <h5>Horario del doctor</h5>
                            <table class="table table-bordered mt-2">
                                <thead>
                                    <tr>
                                        <th>Día</th>
                                        <th>Inicio</th>
                                        <th>Fin</th>
                                        <th>Consultorio</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        data.forEach(h => {
                            html += `
                                <tr>
                                    <td>${h.dia}</td>
                                    <td>${h.inicio}</td>
                                    <td>${h.fin}</td>
                                    <td>${h.consultorio}</td>
                                </tr>`;
                        });

                        html += "</tbody></table>";
                        infoDoctor.innerHTML = html;
                    })
                    .catch(err => console.error(err));
            });

        });
    </script>



}
