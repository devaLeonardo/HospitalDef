@model HospitalDef.Models.Cita

@{
    ViewData["Title"] = "Agendar";
}

<div class="row justify-content-center my-5">

    <div class="col-lg-6 col-md-8 agendar-form-container">

        <div class="form-header text-center mb-4">
            <h1>Agenda una cita para el paciente</h1>
            <h4>Cita</h4>
            <hr />
        </div>

        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <!-- PACIENTE -->
            <div class="form-group mb-3">
                <label asp-for="idPaciente" class="control-label">Paciente:</label>
                <select asp-for="idPaciente" class="form-control" asp-items="@ViewBag.Paciente"></select>
            </div>

            <!-- ESPECIALIDAD -->
            <div class="form-group mb-3">
                <label asp-for="EspecialidadIdFiltro" class="control-label">Especialidad:</label>

                <select asp-for="EspecialidadIdFiltro"
                        id="ddlEspecialidad"
                        class="form-control"
                        asp-items="@(ViewBag.Especialidades as SelectList)">
                    <option value="">-- Selecciona una Especialidad --</option>
                </select>

                <span asp-validation-for="EspecialidadIdFiltro" class="text-danger"></span>
            </div>

            <!-- DOCTOR -->
            <div class="form-group mb-3">
                <label asp-for="idDoctor" class="control-label">Doctor:</label>

                <select asp-for="idDoctor"
                        id="ddlDoctor"
                        class="form-control"
                        asp-items="@(ViewBag.Doctores as SelectList)">
                    <option value="">-- Selecciona un Doctor --</option>
                </select>

                <span asp-validation-for="idDoctor" class="text-danger"></span>
            </div>

            <!-- HORARIO POR AJAX -->
            <div id="doctor-horario" class="mt-3" style="display:none;">
                <!-- Se llenará dinámicamente -->
            </div>

            <!-- FECHA CITA -->
            <div class="form-group mb-4">
                <label asp-for="fechaCita" class="control-label">Fecha y Hora</label>

                <input asp-for="fechaCita"
                       type="datetime-local"
                       class="form-control"
                       value="@Model.fechaCita.ToString("yyyy-MM-ddTHH:mm")" />

                <span asp-validation-for="fechaCita" class="text-danger"></span>
            </div>

            <!-- BOTONES -->
            <div class="d-flex justify-content-between mt-4">
                <a asp-controller="Recepcionistums" asp-action="Index" class="btn btn-outline-secondary">Volver a mi modulo</a>
                <input type="submit" value="Agendar Cita" class="btn btn-outline-primary btn-sm" />
            </div>

        </form>

    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>

        // ===========================
        // CARGAR DOCTORES POR AJAX
        // ===========================
        $(document).ready(function () {

            let especialidadSeleccionada = $("#ddlEspecialidad").val();
            let doctorSeleccionado = "@Model.idDoctor";

            if (especialidadSeleccionada) {
                cargarDoctores(especialidadSeleccionada, doctorSeleccionado);
            }

            $("#ddlEspecialidad").change(function () {
                let espId = $(this).val();
                $("#ddlDoctor").empty().append('<option value="">Cargando...</option>');
                cargarDoctores(espId);
            });

            function cargarDoctores(especialidadId, doctorActual = null) {
                $.ajax({
                    url: '/Citas/GetDoctoresPorEspecialidad',
                    type: 'GET',
                    dataType: 'json',
                    data: { IdEspecialidad: especialidadId },
                    success: function (data) {

                        $("#ddlDoctor").empty().append('<option value="">-- Selecciona un Doctor --</option>');

                        $.each(data, function (i, doctor) {
                            $("#ddlDoctor").append($('<option/>', {
                                value: doctor.value,
                                text: doctor.text
                            }));
                        });

                        if (doctorActual) {
                            $("#ddlDoctor").val(doctorActual);
                            cargarHorarioDoctor(doctorActual);
                        }
                    }
                });
            }

        });


        // ===========================
        // CARGAR HORARIO DEL DOCTOR
        // ===========================
        $("#ddlDoctor").change(function () {
            let idDoctor = $(this).val();
            cargarHorarioDoctor(idDoctor);
        });

        function cargarHorarioDoctor(idDoctor) {

            if (!idDoctor) {
                $("#doctor-horario").hide();
                return;
            }

            $.ajax({
                url: '/Citas/GetHorarioDoctor',
                type: 'GET',
                data: { idDoctor: idDoctor },
                success: function (data) {

                    if (!data || data.length === 0) {
                        $("#doctor-horario")
                            .html("<div class='alert alert-warning mt-2'>El doctor no tiene horario registrado.</div>")
                            .show();
                        return;
                    }

                    let html = `
                        <h4>Horario del Doctor</h4>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Día</th>
                                    <th>Inicio</th>
                                    <th>Fin</th>
                                    <th>Consultorio</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    $.each(data, function (i, h) {
                        html += `
                            <tr>
                                <td>${h.dia}</td>
                                <td>${h.inicio}</td>
                                <td>${h.fin}</td>
                                <td>${h.consultorio}</td>
                            </tr>`;
                    });

                    html += "</tbody></table>";

                    $("#doctor-horario").html(html).show();
                }
            });
        }

    </script>
}
