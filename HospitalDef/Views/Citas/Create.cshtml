@model HospitalDef.Models.Cita

@{
    ViewData["Title"] = "Agendar";
}

<div class="row justify-content-center my-5">

    <div class="col-lg-6 col-md-8 agendar-form-container">

        <div class="form-header text-center mb-4">
            <h1>Agenda tu cita</h1>
            <h4>Cita</h4>
            <hr />
        </div>

        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <!-- PACIENTE -->
            <div class="form-group mb-3">
                <label>Paciente:</label>

                <!-- Nombre visible -->
                <input class="form-control" value="@ViewBag.PacienteNombre" disabled />

                <!-- ID oculto (se mantiene SIEMPRE) -->
                <input type="hidden" asp-for="idPaciente" value="@ViewBag.PacienteId" />
            </div>

            <!-- ESPECIALIDAD -->
            <div class="form-group mb-3">
                <label asp-for="EspecialidadIdFiltro" class="control-label">Especialidad:</label>

                <select asp-for="EspecialidadIdFiltro"
                        id="ddlEspecialidad"
                        class="form-control"
                        asp-items="@(ViewBag.Especialidades as SelectList)">
                    <option value="">-- Selecciona una Especialidad --</option>
                </select>

                <span asp-validation-for="EspecialidadIdFiltro" class="text-danger"></span>
            </div>

            <!-- DOCTOR -->
            <div class="form-group mb-3">
                <label asp-for="idDoctor" class="control-label">Doctor:</label>

                <select asp-for="idDoctor"
                        id="ddlDoctor"
                        class="form-control"
                        asp-items="@(ViewBag.Doctores as SelectList)">
                    <option value="">-- Selecciona un Doctor --</option>
                </select>

                <span asp-validation-for="idDoctor" class="text-danger"></span>
            </div>

            <!-- HORARIO DEL DOCTOR -->
            <div id="doctor-horario" class="alert alert-info" style="display:@(ViewBag.HorarioDoctor != null ? "block" : "none")">

                @if (ViewBag.HorarioDoctor != null)
                {
                    <ul>
                        @foreach (var h in ViewBag.HorarioDoctor)
                        {
                            <li><b>@h.dia</b>: @h.inicio - @h.fin</li>
                        }
                    </ul>
                }
            </div>

            <!-- FECHA CITA -->
            <div class="form-group mb-4">
                <label asp-for="fechaCita" class="control-label">Fecha y Hora</label>

                <input asp-for="fechaCita"
                       type="datetime-local"
                       class="form-control"
                       value="@Model.fechaCita.ToString("yyyy-MM-ddTHH:mm")" />

                <span asp-validation-for="fechaCita" class="text-danger"></span>
            </div>

            <!-- ⭐ BOTONES AL MISMO NIVEL ⭐ -->
            <div class="d-flex justify-content-between mt-4">
                <a asp-controller="Pacientes" asp-action="Index" class="btn btn-outline-secondary">Regresar</a>

                <input type="submit" value="Agendar Cita" class="btn btn-outline-primary btn-sm" />
            </div>

        </form>

    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {

            let especialidadSeleccionada = $("#ddlEspecialidad").val();
            let doctorSeleccionado = "@Model.idDoctor";

            if (especialidadSeleccionada) {
                cargarDoctores(especialidadSeleccionada, doctorSeleccionado);
            }

            $("#ddlEspecialidad").change(function () {
                let espId = $(this).val();
                $("#ddlDoctor").empty().append('<option value="">Cargando...</option>');
                cargarDoctores(espId);
            });

            function cargarDoctores(especialidadId, doctorActual = null) {
                $.ajax({
                    url: '/Citas/GetDoctoresPorEspecialidad',
                    type: 'GET',
                    dataType: 'json',
                    data: { IdEspecialidad: especialidadId },
                    success: function (data) {

                        $("#ddlDoctor").empty().append('<option value="">-- Selecciona un Doctor --</option>');

                        $.each(data, function (i, doctor) {
                            $("#ddlDoctor").append($('<option/>', {
                                value: doctor.value,
                                text: doctor.text
                            }));
                        });

                        if (doctorActual) {
                            $("#ddlDoctor").val(doctorActual);
                        }
                    }
                });
            }

        });

        $("#ddlDoctor").change(function () {
            let doctorId = $(this).val();
            cargarHorarioDoctor(doctorId);
        });

        function cargarHorarioDoctor(idDoctor) {

            if (!idDoctor) {
                $("#doctor-horario").hide();
                return;
            }

            $.ajax({
                url: '/Citas/GetHorarioDoctor',
                type: 'GET',
                data: { idDoctor: idDoctor },
                success: function (data) {

                    if (data.length === 0) {
                        $("#doctor-horario").html("El doctor no tiene horario registrado.");
                        $("#doctor-horario").show();
                        return;
                    }

                    let html = "<ul>";
                    $.each(data, function (i, h) {
                        html += `<li><b>${h.dia}</b>: ${h.inicio} - ${h.fin}</li>`;
                    });
                    html += "</ul>";

                    $("#doctor-horario").html(html);
                    $("#doctor-horario").show();
                }
            });
        }

    </script>
}
