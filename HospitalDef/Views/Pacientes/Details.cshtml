@model IEnumerable<HospitalDef.Models.Paciente>

@{
    ViewData["Title"] = "Pacientes";
}

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<h2 class="mb-4">Listado de Pacientes</h2>

<table class="table table-hover shadow-sm">
    <thead class="table-dark">
        <tr>
            <th>Nombre</th>
            <th>Sexo</th>
            <th>Estado del perfil</th>
            <th class="text-center">Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var p in Model)
        {
            bool tieneCitaPendiente = p.Cita.Any(c => c.estatusAtencion == "PAGADO");
            bool activo = p.IdUsuarioNavigation?.Activo == true;

            <tr>
                <td>
                    @p.Nombre @p.ApellidoP @p.ApellidoM
                </td>

                <td>@p.Sexo</td>

                <td>
                    @if (activo)
                    {
                        <span class="badge bg-success">Activo</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">Inactivo</span>
                    }
                </td>

                <td class="text-center">
                    <a asp-action="Edit"
                       asp-route-id="@p.IdPaciente"
                       class="btn btn-warning btn-sm me-1">
                        Editar
                    </a>

                    @if (activo)
                    {
                        if (tieneCitaPendiente)
                        {
                            <button class="btn btn-secondary btn-sm" disabled
                                    title="Tiene citas pendientes">
                                No disponible
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-danger btn-sm"
                                    onclick="confirmarDesactivar(@p.IdUsuario)">
                                Desactivar
                            </button>
                        }
                    }
                    else
                    {
                        <button class="btn btn-success btn-sm"
                                onclick="confirmarActivar(@p.IdUsuario)">
                            Activar
                        </button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- SweetAlert mensajes backend -->
@if (TempData["Error"] != null)
{
    <script>
        Swal.fire({
            icon: 'error',
            title: 'Acción no permitida',
            text: '@TempData["Error"]',
            showClass: {
                popup: 'animate__animated animate__shakeX'
            }
        });
    </script>
}

@if (TempData["Success"] != null)
{
    <script>
        Swal.fire({
            icon: 'success',
            title: 'Operación exitosa',
            text: '@TempData["Success"]',
            timer: 2000,
            showConfirmButton: false
        });
    </script>
}

<!-- Funciones SweetAlert -->
<script>
    function confirmarDesactivar(idUsuario) {
        Swal.fire({
            title: '¿Desactivar paciente?',
            text: 'No podrá agendar citas mientras esté inactivo.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, desactivar',
            cancelButtonText: 'Cancelar',
            showClass: {
                popup: 'animate__animated animate__fadeInDown'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/Pacientes/Desactivar/${idUsuario}`;
            }
        });
    }

    function confirmarActivar(idUsuario) {
        Swal.fire({
            title: '¿Activar paciente?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#198754',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, activar',
            cancelButtonText: 'Cancelar',
            showClass: {
                popup: 'animate__animated animate__fadeInDown'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/Pacientes/Activar/${idUsuario}`;
            }
        });
    }
</script>
